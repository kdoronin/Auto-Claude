---
phase: 03-cross-validation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/backend/runners/github/services/parallel_orchestrator_reviewer.py
  - apps/backend/prompts/github/pr_parallel_orchestrator.md
autonomous: true

must_haves:
  truths:
    - "Findings track which agents reported them via source_agents field"
    - "When 2+ agents report same issue (file+line+category), confidence is boosted"
    - "cross_validated field is set to True for multi-agent findings"
    - "AgentAgreement is populated with agreed and conflicting finding IDs"
  artifacts:
    - path: "apps/backend/runners/github/services/parallel_orchestrator_reviewer.py"
      provides: "Cross-validation logic"
      contains: "_cross_validate_findings"
    - path: "apps/backend/prompts/github/pr_parallel_orchestrator.md"
      provides: "Cross-validation documentation"
      contains: "Multi-Agent Agreement"
  key_links:
    - from: "parallel_orchestrator_reviewer.py"
      to: "_cross_validate_findings"
      via: "Called before confidence routing"
      pattern: "_cross_validate_findings\\(.*findings"
---

<objective>
Add multi-agent cross-validation to boost confidence when agents agree

Purpose: Increase confidence when multiple specialist agents independently flag the same issue, and track agent agreement for the verdict.
Output: Cross-validation logic in parallel_orchestrator_reviewer.py that merges findings and tracks agreement, updated orchestrator prompt with multi-agent agreement documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cross-validation/03-RESEARCH.md
@.planning/phases/03-cross-validation/03-01-SUMMARY.md
@apps/backend/runners/github/services/parallel_orchestrator_reviewer.py
@apps/backend/runners/github/services/pydantic_models.py
@apps/backend/prompts/github/pr_parallel_orchestrator.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-validation function</name>
  <files>apps/backend/runners/github/services/parallel_orchestrator_reviewer.py</files>
  <action>
Add `_cross_validate_findings()` method to ParallelOrchestratorReviewer class.

The function should:
1. Group findings by location key: (file, line, category)
2. For groups with 2+ findings (multi-agent agreement):
   - Merge into single finding (keep highest severity)
   - Boost confidence by 0.15 (capped at 0.95)
   - Set cross_validated = True
   - Collect all source agents into source_agents list
   - Combine evidence from all findings (join with "\n---\n")
3. For single-agent findings:
   - Keep as-is
   - Ensure source_agents is populated (use finding's original agent if available)
4. Track agreement in an AgentAgreement object:
   - agreed_findings: IDs of merged multi-agent findings
   - conflicting_findings: IDs where agents disagreed on severity (not implemented yet - defer)
5. Return tuple of (validated_findings, agent_agreement)

Place after _deduplicate_findings method but before _apply_confidence_routing.

Key implementation details:
- Use collections.defaultdict to group findings
- Finding merge logic: highest severity wins, combine descriptions
- Don't use complex conflict detection yet - just track agreement

Reference the existing AgentAgreement model from pydantic_models.py.
  </action>
  <verify>
Read the modified file and verify:
- `_cross_validate_findings()` method exists
- Method groups by (file, line, category) tuple
- Multi-agent findings get confidence boost and cross_validated=True
- Returns (findings_list, AgentAgreement)
  </verify>
  <done>Cross-validation function added with agreement tracking</done>
</task>

<task type="auto">
  <name>Task 2: Wire cross-validation into review pipeline</name>
  <files>apps/backend/runners/github/services/parallel_orchestrator_reviewer.py</files>
  <action>
Integrate `_cross_validate_findings()` into the `review()` method.

The integration point is BEFORE confidence routing (which was added in 03-01):

1. After deduplication but BEFORE the evidence/scope validation loop
2. Call `_cross_validate_findings()` on deduplicated findings
3. Use the returned findings and agent_agreement
4. Pass cross-validated findings through the evidence/scope validation loop
5. Then through confidence routing
6. Include agent_agreement in the final PRReviewResult

The order should be:
1. Deduplicate findings
2. Cross-validate (merge multi-agent findings, track agreement)
3. Evidence/scope validation
4. Confidence routing
5. Generate verdict

Add logging:
```python
logger.info(
    f"[PRReview] Cross-validation: {len(agent_agreement.agreed_findings)} multi-agent, "
    f"{len(findings) - len(agent_agreement.agreed_findings)} single-agent"
)
```

Note: PRReviewResult may not have an agent_agreement field - if so, that's fine. The AgentAgreement is tracked in the structured output from the orchestrator prompt, not in PRReviewResult. Just log the results.
  </action>
  <verify>
Read the review() method and verify:
- `_cross_validate_findings()` is called after deduplication
- Cross-validated findings flow through evidence/scope validation
- Cross-validated findings flow through confidence routing
- Logging shows cross-validation results
  </verify>
  <done>Cross-validation integrated into review pipeline in correct order</done>
</task>

<task type="auto">
  <name>Task 3: Update orchestrator prompt with multi-agent agreement docs</name>
  <files>apps/backend/prompts/github/pr_parallel_orchestrator.md</files>
  <action>
Update the orchestrator prompt to document multi-agent agreement behavior.

Add a new section after "Confidence Tiers" called "## Multi-Agent Agreement":

```markdown
## Multi-Agent Agreement

When multiple specialist agents flag the same issue (same file + line + category), this is strong signal:

### Confidence Boost
- If 2+ agents agree: confidence boosted by +0.15 (max 0.95)
- cross_validated field set to true
- source_agents lists all agents that flagged the issue

### Why This Matters
- Independent verification increases certainty
- False positives rarely get flagged by multiple specialized agents
- Multi-agent agreement often indicates real issues

### Example
```
security-reviewer finds: XSS vulnerability at line 45 (confidence: 0.75)
quality-reviewer finds: Unsafe string interpolation at line 45 (confidence: 0.70)

Result: Single finding with confidence 0.90 (0.75 + 0.15 boost)
        source_agents: ["security-reviewer", "quality-reviewer"]
        cross_validated: true
```

### Agent Agreement Output
The `agent_agreement` field in output tracks:
- `agreed_findings`: Finding IDs where 2+ agents agreed
- `conflicting_findings`: Finding IDs where agents disagreed (reserved for future)
- `resolution_notes`: How conflicts were resolved (reserved for future)
```

Also update the existing Phase 3: Synthesis section to reference the cross-validation behavior and how it works with confidence routing.
  </action>
  <verify>
Read the prompt file and verify:
- "Multi-Agent Agreement" section exists with confidence boost documentation
- Example shows how multi-agent findings are merged
- Agent agreement output format is documented
  </verify>
  <done>Orchestrator prompt updated with multi-agent agreement documentation</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run: `apps/backend/.venv/bin/python -c "from runners.github.services.parallel_orchestrator_reviewer import ParallelOrchestratorReviewer; print('Import OK')"`
2. Verify no syntax errors in modified files
3. Grep for "_cross_validate_findings" to confirm the method exists and is called
4. Verify pipeline order: deduplicate -> cross-validate -> validate evidence/scope -> confidence route
</verification>

<success_criteria>
- Cross-validation function exists and merges multi-agent findings
- Confidence boosted by 0.15 for 2+ agent agreement (capped at 0.95)
- cross_validated and source_agents fields populated correctly
- AgentAgreement tracks agreed_findings
- Function wired into review pipeline before confidence routing
- Orchestrator prompt documents multi-agent agreement behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-cross-validation/03-02-SUMMARY.md`
</output>
